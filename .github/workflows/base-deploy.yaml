---
name: Deploy

# yamllint disable-line rule:truthy
on:
  workflow_call:

permissions:
  contents: read
  packages: write

concurrency:
  group: queue

jobs:
  information:
    if: |
      github.event_name != 'workflow_run'
      || github.event.workflow_run.conclusion == 'success'
    name: ‚ÑπÔ∏è Gather app information
    runs-on: ubuntu-latest
    outputs:
      architectures: ${{ steps.information.outputs.architectures }}
      build: ${{ steps.information.outputs.build }}
      environment: ${{ steps.release.outputs.environment }}
      slug: ${{ steps.information.outputs.slug }}
      target: ${{ steps.information.outputs.target }}
      version: ${{ steps.release.outputs.version }}
    steps:
      - name: ‚§µÔ∏è Check out code from GitHub
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - name: üöÄ Run app information action
        id: information
        uses: frenck/action-addon-information@ce1377e9851cf569c29329e65fb2c57e67ca0f69 # v1.4.2
      - name: ‚ÑπÔ∏è Gather version and environment
        id: release
        env:
          EVENT_NAME: ${{ github.event_name }}
          TAG_NAME: ${{ github.event.release.tag_name }}
          IS_PRERELEASE: ${{ github.event.release.prerelease }}
          SHA: ${{ github.sha }}
        run: |
          environment="edge"
          version="${SHA:0:7}"
          if [[ "${EVENT_NAME}" = "release" ]]; then
            version="${TAG_NAME}"
            version="${version,,}"
            version="${version#v}"
            environment="stable"
            if [[ "${IS_PRERELEASE}" = "true" ]]; then
              environment="beta"
            fi
          fi

          echo "environment=${environment}" >> "$GITHUB_OUTPUT"
          echo "version=${version}" >> "$GITHUB_OUTPUT"

  deploy:
    name: üë∑ Build & Deploy ${{ matrix.architecture }}
    needs: information
    runs-on: ${{ matrix.architecture == 'aarch64' && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    strategy:
      matrix:
        architecture: ${{ fromJson(needs.information.outputs.architectures) }}
    steps:
      - name: ‚§µÔ∏è Check out code from GitHub
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - name: üèó Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0
      - name: ‚ÑπÔ∏è Compose build flags
        id: flags
        env:
          ARCHITECTURE: ${{ matrix.architecture }}
          BUILD_FILE: ${{ needs.information.outputs.build }}
        run: |
          echo "date=$(date +"%Y-%m-%dT%H:%M:%SZ")" >> "$GITHUB_OUTPUT"
          from=$(yq --no-colors eval ".build_from.${ARCHITECTURE}" "${BUILD_FILE}")
          echo "from=${from}" >> "$GITHUB_OUTPUT"

          if [[ "${ARCHITECTURE}" = "amd64" ]]; then
            echo "platform=linux/amd64" >> "$GITHUB_OUTPUT"
          elif [[ "${ARCHITECTURE}" = "aarch64" ]]; then
            echo "platform=linux/arm64/v8" >> "$GITHUB_OUTPUT"
          else
            echo "::error ::Could not determine platform for architecture ${ARCHITECTURE}"
            exit 1
          fi
      - name: üèó  Login to GitHub Container Registry
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: üöÄ Build and push
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6.19.2
        with:
          outputs: type=image,push=true,compression=zstd,compression-level=9,force-compression=true,oci-mediatypes=true
          # yamllint disable rule:line-length
          tags: |
            ghcr.io/${{ github.repository_owner }}/${{ needs.information.outputs.slug }}/${{ matrix.architecture }}:${{ needs.information.outputs.environment }}
            ghcr.io/${{ github.repository_owner }}/${{ needs.information.outputs.slug }}/${{ matrix.architecture }}:${{ needs.information.outputs.version }}
          # yamllint enable rule:line-length
          # zizmor: ignore[template-injection] - path input to action, not shell-executed
          context: ${{ needs.information.outputs.target }}
          file: ${{ needs.information.outputs.target }}/Dockerfile
          cache-from: |
            type=gha,scope=${{ matrix.architecture }}
            type=registry,ref=ghcr.io/${{ github.repository_owner }}/${{ needs.information.outputs.slug }}/${{ matrix.architecture }}:edge
          cache-to: type=gha,mode=max,scope=${{ matrix.architecture }}
          platforms: ${{ steps.flags.outputs.platform }}
          build-args: |
            BUILD_ARCH=${{ matrix.architecture }}
            BUILD_DATE=${{ steps.flags.outputs.date }}
            BUILD_FROM=${{ steps.flags.outputs.from }}
            BUILD_REF=${{ github.sha }}
            BUILD_REPOSITORY=${{ github.repository }}
            BUILD_VERSION=${{ needs.information.outputs.version }}

  manifest:
    name: üë∑ Build & Push Multi Arch Manifest
    needs:
      - information
      - deploy
    runs-on: ubuntu-latest
    steps:
      - name: üèó Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0
      - name: üèó  Login to GitHub Container Registry
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: üöÄ Create and push manifest
        env:
          REPO_OWNER: ${{ github.repository_owner }}
          SLUG: ${{ needs.information.outputs.slug }}
          ENVIRONMENT: ${{ needs.information.outputs.environment }}
          VERSION: ${{ needs.information.outputs.version }}
          ARCHITECTURES: ${{ needs.information.outputs.architectures }}
        # yamllint disable rule:line-length
        run: |
          sources=()
          for arch in $(echo "${ARCHITECTURES}" | jq -r '.[]'); do
            sources+=("ghcr.io/${REPO_OWNER}/${SLUG}/${arch}:${VERSION}")
          done

          docker buildx imagetools create \
            --tag "ghcr.io/${REPO_OWNER}/${SLUG}:${ENVIRONMENT}" \
            "${sources[@]}"

          docker buildx imagetools create \
            --tag "ghcr.io/${REPO_OWNER}/${SLUG}:${VERSION}" \
            "${sources[@]}"
