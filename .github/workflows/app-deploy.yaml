---
name: Deploy

concurrency:
  group: queue

# yamllint disable-line rule:truthy
on:
  workflow_call:
    inputs:
      slug:
        description: Overrides the detected slug
        required: false
        type: string
      repository:
        default: "repository"
        description: The name of the stable repository
        required: false
        type: string
      repository_edge:
        default: "repository-edge"
        description: The name of the edge repository
        required: false
        type: string
      repository_beta:
        default: "repository-beta"
        description: The name of the beta repository
        required: false
        type: string
    secrets:
      DISPATCH_TOKEN:
        required: true

permissions:
  contents: read
  packages: write

jobs:
  information:
    if: |
      github.event_name == 'release'
      || (
        github.event_name == 'workflow_run'
        && github.event.workflow_run.conclusion == 'success'
      )
    name: â„¹ï¸ Gather app information
    runs-on: ubuntu-latest
    outputs:
      architectures: ${{ steps.information.outputs.architectures }}
      build: ${{ steps.information.outputs.build }}
      description: ${{ steps.information.outputs.description }}
      environment: ${{ steps.release.outputs.environment }}
      name: ${{ steps.information.outputs.name }}
      slug: ${{ steps.override.outputs.slug }}
      target: ${{ steps.information.outputs.target }}
      version: ${{ steps.release.outputs.version }}
    steps:
      - name: â¤µï¸ Check out code from GitHub
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          persist-credentials: false
      - name: ðŸš€ Run app information action
        id: information
        uses: frenck/action-addon-information@ce1377e9851cf569c29329e65fb2c57e67ca0f69  # v1.4.2
      - name: ðŸš€ Process possible slug override
        id: override
        env:
          DETECTED_SLUG: ${{ steps.information.outputs.slug }}
          INPUT_SLUG: ${{ inputs.slug }}
        run: |
          slug="${DETECTED_SLUG}"
          if [[ -n "${INPUT_SLUG}" ]]; then
            slug="${INPUT_SLUG}"
          fi
          echo "slug=${slug}" >> "$GITHUB_OUTPUT"
      - name: â„¹ï¸ Gather version and environment
        id: release
        env:
          EVENT_NAME: ${{ github.event_name }}
          TAG_NAME: ${{ github.event.release.tag_name }}
          IS_PRERELEASE: ${{ github.event.release.prerelease }}
          SHA: ${{ github.sha }}
        run: |
          environment="edge"
          version="${SHA:0:7}"
          if [[ "${EVENT_NAME}" = "release" ]]; then
            version="${TAG_NAME}"
            version="${version,,}"
            version="${version#v}"
            environment="stable"
            if [[ "${IS_PRERELEASE}" = "true" ]]; then
              environment="beta"
            fi
          fi

          echo "environment=${environment}" >> "$GITHUB_OUTPUT"
          echo "version=${version}" >> "$GITHUB_OUTPUT"

  deploy:
    name: ðŸ‘· Build & Deploy ${{ matrix.architecture }}
    needs: information
    runs-on: ${{ matrix.architecture == 'aarch64' && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    strategy:
      matrix:
        architecture: ${{ fromJson(needs.information.outputs.architectures) }}
    steps:
      - name: â¤µï¸ Check out code from GitHub
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          persist-credentials: false
      - name: ðŸ— Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f  # v3.12.0
      - name: â„¹ï¸ Compose build flags
        id: flags
        env:
          ARCHITECTURE: ${{ matrix.architecture }}
          BUILD_FILE: ${{ needs.information.outputs.build }}
        run: |
          echo "date=$(date +"%Y-%m-%dT%H:%M:%SZ")" >> "$GITHUB_OUTPUT"
          from=$(yq --no-colors eval ".build_from.${ARCHITECTURE}" "${BUILD_FILE}")
          echo "from=${from}" >> "$GITHUB_OUTPUT"

          if [[ "${ARCHITECTURE}" = "amd64" ]]; then
            echo "platform=linux/amd64" >> "$GITHUB_OUTPUT"
          elif [[ "${ARCHITECTURE}" = "aarch64" ]]; then
            echo "platform=linux/arm64/v8" >> "$GITHUB_OUTPUT"
          else
            echo "::error ::Could not determine platform for architecture ${ARCHITECTURE}"
            exit 1
          fi
      - name: ðŸ—  Login to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef  # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: ðŸš€ Build
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83  # v6.18.0
        with:
          load: true
          # yamllint disable rule:line-length
          tags: |
            ghcr.io/${{ github.repository_owner }}/${{ needs.information.outputs.slug }}/${{ matrix.architecture }}:${{ needs.information.outputs.environment }}
            ghcr.io/${{ github.repository_owner }}/${{ needs.information.outputs.slug }}/${{ matrix.architecture }}:${{ needs.information.outputs.version }}
          # yamllint enable rule:line-length
          context: ${{ needs.information.outputs.target }}
          file: ${{ needs.information.outputs.target }}/Dockerfile
          cache-from: |
            type=gha,scope=${{ matrix.architecture }}
            type=registry,ref=ghcr.io/${{ github.repository_owner }}/${{ needs.information.outputs.slug }}/${{ matrix.architecture }}:edge
          cache-to: type=gha,mode=max,scope=${{ matrix.architecture }}
          platforms: ${{ steps.flags.outputs.platform }}
          build-args: |
            BUILD_ARCH=${{ matrix.architecture }}
            BUILD_DATE=${{ steps.flags.outputs.date }}
            BUILD_DESCRIPTION=${{ needs.information.outputs.description }}
            BUILD_FROM=${{ steps.flags.outputs.from }}
            BUILD_NAME=${{ needs.information.outputs.name }}
            BUILD_REF=${{ github.sha }}
            BUILD_REPOSITORY=${{ github.repository }}
            BUILD_VERSION=${{ needs.information.outputs.version }}
      - name: ðŸš€ Push
        env:
          REPO_OWNER: ${{ github.repository_owner }}
          SLUG: ${{ needs.information.outputs.slug }}
          ARCHITECTURE: ${{ matrix.architecture }}
          ENVIRONMENT: ${{ needs.information.outputs.environment }}
          VERSION: ${{ needs.information.outputs.version }}
        # yamllint disable rule:line-length
        run: |
          docker push \
            "ghcr.io/${REPO_OWNER}/${SLUG}/${ARCHITECTURE}:${ENVIRONMENT}"
          docker push \
            "ghcr.io/${REPO_OWNER}/${SLUG}/${ARCHITECTURE}:${VERSION}"

  manifest:
    name: ðŸ‘· Build & Push Multi Arch Manifest
    needs:
      - information
      - deploy
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ— Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f  # v3.12.0
      - name: ðŸ—  Login to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef  # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: ðŸš€ Create and push manifest
        env:
          REPO_OWNER: ${{ github.repository_owner }}
          SLUG: ${{ needs.information.outputs.slug }}
          ENVIRONMENT: ${{ needs.information.outputs.environment }}
          VERSION: ${{ needs.information.outputs.version }}
        # yamllint disable rule:line-length
        run: |
          docker buildx imagetools create \
            --tag "ghcr.io/${REPO_OWNER}/${SLUG}:${ENVIRONMENT}" \
            "ghcr.io/${REPO_OWNER}/${SLUG}/amd64:${VERSION}" \
            "ghcr.io/${REPO_OWNER}/${SLUG}/aarch64:${VERSION}"

          docker buildx imagetools create \
            --tag "ghcr.io/${REPO_OWNER}/${SLUG}:${VERSION}" \
            "ghcr.io/${REPO_OWNER}/${SLUG}/amd64:${VERSION}" \
            "ghcr.io/${REPO_OWNER}/${SLUG}/aarch64:${VERSION}"

  publish-edge:
    name: ðŸ“¢ Publish to edge repository
    if: needs.information.outputs.environment == 'edge'
    needs:
      - information
      - deploy
    environment:
      name: ${{ needs.information.outputs.environment }}
    runs-on: ubuntu-latest
    steps:
      - name: ðŸš€ Dispatch repository updater update signal
        uses: peter-evans/repository-dispatch@28959ce8df70de7be546dd1250a005dd32156697  # v4.0.1
        with:
          token: ${{ secrets.DISPATCH_TOKEN }}
          repository: ${{ github.repository_owner }}/${{ inputs.repository_edge }}
          event-type: update
          client-payload: >
            {
              "app": "${{ needs.information.outputs.slug }}",
              "name": "${{ needs.information.outputs.name }}",
              "repository": "${{ github.repository }}",
              "version": "${{ needs.information.outputs.version }}"
            }

  publish-beta:
    name: ðŸ“¢ Publish to beta repository
    if: |
      needs.information.outputs.environment == 'beta' ||
      needs.information.outputs.environment == 'stable'
    needs:
      - information
      - deploy
    environment:
      name: ${{ needs.information.outputs.environment }}
    runs-on: ubuntu-latest
    steps:
      - name: ðŸš€ Dispatch repository updater update signal
        uses: peter-evans/repository-dispatch@28959ce8df70de7be546dd1250a005dd32156697  # v4.0.1
        with:
          token: ${{ secrets.DISPATCH_TOKEN }}
          repository: ${{ github.repository_owner }}/${{ inputs.repository_beta }}
          event-type: update
          client-payload: >
            {
              "app": "${{ needs.information.outputs.slug }}",
              "name": "${{ needs.information.outputs.name }}",
              "repository": "${{ github.repository }}",
              "version": "${{ github.event.release.tag_name }}"
            }

  publish-stable:
    name: ðŸ“¢ Publish to stable repository
    if: needs.information.outputs.environment == 'stable'
    needs:
      - information
      - deploy
    environment:
      name: ${{ needs.information.outputs.environment }}
    runs-on: ubuntu-latest
    steps:
      - name: ðŸš€ Dispatch repository updater update signal
        uses: peter-evans/repository-dispatch@28959ce8df70de7be546dd1250a005dd32156697  # v4.0.1
        with:
          token: ${{ secrets.DISPATCH_TOKEN }}
          repository: ${{ github.repository_owner }}/${{ inputs.repository }}
          event-type: update
          client-payload: >
            {
              "app": "${{ needs.information.outputs.slug }}",
              "name": "${{ needs.information.outputs.name }}",
              "repository": "${{ github.repository }}",
              "version": "${{ github.event.release.tag_name }}"
            }
